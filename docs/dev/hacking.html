

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-CN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-CN" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Docutils Hacker’s Guide &mdash; docutils-docs v2019.04.12 文档</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="../_static/translations.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../contents.html" class="icon icon-home"> docutils-docs
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../overviews.html">Docutils: Documentation Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Docutils 项目文档概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release/index.html">版本发布</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc.html">文档实用程序</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rst.html">Docutils 的标记语法和解析器组件</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/index.html">用户文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ref/index.html">参考文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html">Developer Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../howto/index.html">基本知识</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API Documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../contents.html">docutils-docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../contents.html">Docs</a> &raquo;</li>
        
      <li>Docutils Hacker’s Guide</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/dev/hacking.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="docutils-hacker-s-guide">
<h1><a class="reference external" href="http://docutils.sourceforge.net/">Docutils</a> Hacker’s Guide<a class="headerlink" href="#docutils-hacker-s-guide" title="永久链接至标题">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Author</dt>
<dd class="field-odd"><p>Lea Wiemann</p>
</dd>
<dt class="field-even">Contact</dt>
<dd class="field-even"><p><a class="reference external" href="mailto:docutils-develop&#37;&#52;&#48;lists&#46;sourceforge&#46;net">docutils-develop<span>&#64;</span>lists<span>&#46;</span>sourceforge<span>&#46;</span>net</a></p>
</dd>
<dt class="field-odd">Revision</dt>
<dd class="field-odd"><p>$Revision: 7302 $</p>
</dd>
<dt class="field-even">Date</dt>
<dd class="field-even"><p>$Date: 2012-01-03 20:23:53 +0100 (Di, 03. J盲n 2012) $</p>
</dd>
<dt class="field-odd">Copyright</dt>
<dd class="field-odd"><p>This document has been placed in the public domain.</p>
</dd>
<dt class="field-even">Abstract</dt>
<dd class="field-even"><p>This is the introduction to Docutils for all persons who
want to extend Docutils in some way.</p>
</dd>
<dt class="field-odd">Prerequisites</dt>
<dd class="field-odd"><p>You have used <a class="reference external" href="http://docutils.sourceforge.net/rst.html">reStructuredText</a> and played around with
the <a class="reference external" href="../user/tools.html">Docutils front-end tools</a> before.  Some (basic) Python
knowledge is certainly helpful (though not necessary, strictly
speaking).</p>
</dd>
</dl>
<div class="contents topic" id="id1">
<p class="topic-title first">目录</p>
<ul class="simple">
<li><p><a class="reference internal" href="#docutils-hacker-s-guide" id="id2">Docutils Hacker’s Guide</a></p>
<ul>
<li><p><a class="reference internal" href="#overview-of-the-docutils-architecture" id="id3">Overview of the Docutils Architecture</a></p>
<ul>
<li><p><a class="reference internal" href="#reading-the-document" id="id4">Reading the Document</a></p></li>
<li><p><a class="reference internal" href="#parsing-the-document" id="id5">Parsing the Document</a></p></li>
<li><p><a class="reference internal" href="#transforming-the-document" id="id6">Transforming the Document</a></p></li>
<li><p><a class="reference internal" href="#writing-the-document" id="id7">Writing the Document</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#extending-docutils" id="id8">Extending Docutils</a></p>
<ul>
<li><p><a class="reference internal" href="#modifying-the-document-tree-before-it-is-written" id="id9">Modifying the Document Tree Before It Is Written</a></p></li>
<li><p><a class="reference internal" href="#the-node-interface" id="id10">The Node Interface</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#what-now" id="id11">What Now?</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview-of-the-docutils-architecture">
<h2><a class="toc-backref" href="#id3">Overview of the Docutils Architecture</a><a class="headerlink" href="#overview-of-the-docutils-architecture" title="永久链接至标题">¶</a></h2>
<p>To give you an understanding of the Docutils architecture, we’ll dive
right into the internals using a practical example.</p>
<p>Consider the following reStructuredText file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">My</span> <span class="o">*</span><span class="n">favorite</span><span class="o">*</span> <span class="n">language</span> <span class="ow">is</span> <span class="n">Python_</span><span class="o">.</span>

<span class="o">..</span> <span class="n">_Python</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">org</span><span class="o">/</span>
</pre></div>
</div>
<p>Using the <code class="docutils literal notranslate"><span class="pre">rst2html.py</span></code> front-end tool, you would get an HTML output
which looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">uninteresting</span> <span class="n">HTML</span> <span class="n">code</span> <span class="n">removed</span><span class="p">]</span>
<span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;document&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">My</span> <span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="n">favorite</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span> <span class="n">language</span> <span class="ow">is</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;reference&quot;</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;http://www.python.org/&quot;</span><span class="o">&gt;</span><span class="n">Python</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;.&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>While this looks very simple, it’s enough to illustrate all internal
processing stages of Docutils.  Let’s see how this document is
processed from the reStructuredText source to the final HTML output:</p>
<div class="section" id="reading-the-document">
<h3><a class="toc-backref" href="#id4">Reading the Document</a><a class="headerlink" href="#reading-the-document" title="永久链接至标题">¶</a></h3>
<p>The <strong>Reader</strong> reads the document from the source file and passes it
to the parser (see below).  The default reader is the standalone
reader (<code class="docutils literal notranslate"><span class="pre">docutils/readers/standalone.py</span></code>) which just reads the input
data from a single text file.  Unless you want to do really fancy
things, there is no need to change that.</p>
<p>Since you probably won’t need to touch readers, we will just move on
to the next stage:</p>
</div>
<div class="section" id="parsing-the-document">
<h3><a class="toc-backref" href="#id5">Parsing the Document</a><a class="headerlink" href="#parsing-the-document" title="永久链接至标题">¶</a></h3>
<p>The <strong>Parser</strong> analyzes the the input document and creates a <strong>node
tree</strong> representation.  In this case we are using the
<strong>reStructuredText parser</strong> (<code class="docutils literal notranslate"><span class="pre">docutils/parsers/rst/__init__.py</span></code>).
To see what that node tree looks like, we call <code class="docutils literal notranslate"><span class="pre">quicktest.py</span></code> (which
can be found in the <code class="docutils literal notranslate"><span class="pre">tools/</span></code> directory of the Docutils distribution)
with our example file (<code class="docutils literal notranslate"><span class="pre">test.txt</span></code>) as first parameter (Windows users
might need to type <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">quicktest.py</span> <span class="pre">test.txt</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ quicktest.py test.txt
&lt;document source=&quot;test.txt&quot;&gt;
    &lt;paragraph&gt;
        My
        &lt;emphasis&gt;
            favorite
         language is
        &lt;reference name=&quot;Python&quot; refname=&quot;python&quot;&gt;
            Python
        .
    &lt;target ids=&quot;python&quot; names=&quot;python&quot; refuri=&quot;http://www.python.org/&quot;&gt;
</pre></div>
</div>
<p>Let us now examine the node tree:</p>
<p>The top-level node is <code class="docutils literal notranslate"><span class="pre">document</span></code>.  It has a <code class="docutils literal notranslate"><span class="pre">source</span></code> attribute
whose value is <code class="docutils literal notranslate"><span class="pre">text.txt</span></code>.  There are two children: A <code class="docutils literal notranslate"><span class="pre">paragraph</span></code>
node and a <code class="docutils literal notranslate"><span class="pre">target</span></code> node.  The <code class="docutils literal notranslate"><span class="pre">paragraph</span></code> in turn has children: A
text node (“My “), an <code class="docutils literal notranslate"><span class="pre">emphasis</span></code> node, a text node (” language is “),
a <code class="docutils literal notranslate"><span class="pre">reference</span></code> node, and again a <code class="docutils literal notranslate"><span class="pre">Text</span></code> node (“.”).</p>
<p>These node types (<code class="docutils literal notranslate"><span class="pre">document</span></code>, <code class="docutils literal notranslate"><span class="pre">paragraph</span></code>, <code class="docutils literal notranslate"><span class="pre">emphasis</span></code>, etc.) are
all defined in <code class="docutils literal notranslate"><span class="pre">docutils/nodes.py</span></code>.  The node types are internally
arranged as a class hierarchy (for example, both <code class="docutils literal notranslate"><span class="pre">emphasis</span></code> and
<code class="docutils literal notranslate"><span class="pre">reference</span></code> have the common superclass <code class="docutils literal notranslate"><span class="pre">Inline</span></code>).  To get an
overview of the node class hierarchy, use epydoc (type <code class="docutils literal notranslate"><span class="pre">epydoc</span>
<span class="pre">nodes.py</span></code>) and look at the class hierarchy tree.</p>
</div>
<div class="section" id="transforming-the-document">
<h3><a class="toc-backref" href="#id6">Transforming the Document</a><a class="headerlink" href="#transforming-the-document" title="永久链接至标题">¶</a></h3>
<p>In the node tree above, the <code class="docutils literal notranslate"><span class="pre">reference</span></code> node does not contain the
target URI (<code class="docutils literal notranslate"><span class="pre">http://www.python.org/</span></code>) yet.</p>
<p>Assigning the target URI (from the <code class="docutils literal notranslate"><span class="pre">target</span></code> node) to the
<code class="docutils literal notranslate"><span class="pre">reference</span></code> node is <em>not</em> done by the parser (the parser only
translates the input document into a node tree).</p>
<p>Instead, it’s done by a <strong>Transform</strong>.  In this case (resolving a
reference), it’s done by the <code class="docutils literal notranslate"><span class="pre">ExternalTargets</span></code> transform in
<code class="docutils literal notranslate"><span class="pre">docutils/transforms/references.py</span></code>.</p>
<p>In fact, there are quite a lot of Transforms, which do various useful
things like creating the table of contents, applying substitution
references or resolving auto-numbered footnotes.</p>
<p>The Transforms are applied after parsing.  To see how the node tree
has changed after applying the Transforms, we use the
<code class="docutils literal notranslate"><span class="pre">rst2pseudoxml.py</span></code> tool:</p>
<pre class="literal-block">$ rst2pseudoxml.py test.txt
&lt;document source=&quot;test.txt&quot;&gt;
    &lt;paragraph&gt;
        My
        &lt;emphasis&gt;
            favorite
         language is
        &lt;reference name=&quot;Python&quot; <strong>refuri=&quot;http://www.python.org/&quot;</strong>&gt;
            Python
        .
    &lt;target ids=&quot;python&quot; names=&quot;python&quot; <code class="docutils literal notranslate"><span class="pre">refuri=&quot;http://www.python.org/&quot;</span></code>&gt;</pre>
<p>For our small test document, the only change is that the <code class="docutils literal notranslate"><span class="pre">refname</span></code>
attribute of the reference has been replaced by a <code class="docutils literal notranslate"><span class="pre">refuri</span></code>
attribute—the reference has been resolved.</p>
<p>While this does not look very exciting, transforms are a powerful tool
to apply any kind of transformation on the node tree.</p>
<p>By the way, you can also get a “real” XML representation of the node
tree by using <code class="docutils literal notranslate"><span class="pre">rst2xml.py</span></code> instead of <code class="docutils literal notranslate"><span class="pre">rst2pseudoxml.py</span></code>.</p>
</div>
<div class="section" id="writing-the-document">
<h3><a class="toc-backref" href="#id7">Writing the Document</a><a class="headerlink" href="#writing-the-document" title="永久链接至标题">¶</a></h3>
<p>To get an HTML document out of the node tree, we use a <strong>Writer</strong>, the
HTML writer in this case (<code class="docutils literal notranslate"><span class="pre">docutils/writers/html4css1.py</span></code>).</p>
<p>The writer receives the node tree and returns the output document.
For HTML output, we can test this using the <code class="docutils literal notranslate"><span class="pre">rst2html.py</span></code> tool:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ rst2html.py --link-stylesheet test.txt
&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;
&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;
&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot; xml:lang=&quot;en&quot; lang=&quot;en&quot;&gt;
&lt;head&gt;
&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;
&lt;meta name=&quot;generator&quot; content=&quot;Docutils 0.3.10: http://docutils.sourceforge.net/&quot; /&gt;
&lt;title&gt;&lt;/title&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;../docutils/writers/html4css1/html4css1.css&quot; type=&quot;text/css&quot; /&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div class=&quot;document&quot;&gt;
&lt;p&gt;My &lt;em&gt;favorite&lt;/em&gt; language is &lt;a class=&quot;reference&quot; href=&quot;http://www.python.org/&quot;&gt;Python&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
<p>So here we finally have our HTML output.  The actual document contents
are in the fourth-last line.  Note, by the way, that the HTML writer
did not render the (invisible) <code class="docutils literal notranslate"><span class="pre">target</span></code> node—only the
<code class="docutils literal notranslate"><span class="pre">paragraph</span></code> node and its children appear in the HTML output.</p>
</div>
</div>
<div class="section" id="extending-docutils">
<h2><a class="toc-backref" href="#id8">Extending Docutils</a><a class="headerlink" href="#extending-docutils" title="永久链接至标题">¶</a></h2>
<p>Now you’ll ask, “how do I actually extend Docutils?”</p>
<p>First of all, once you are clear about <em>what</em> you want to achieve, you
have to decide <em>where</em> to implement it—in the Parser (e.g. by
adding a directive or role to the reStructuredText parser), as a
Transform, or in the Writer.  There is often one obvious choice among
those three (Parser, Transform, Writer).  If you are unsure, ask on
the <a class="reference external" href="../user/mailing-lists.html#docutils-develop">Docutils-develop</a> mailing list.</p>
<p>In order to find out how to start, it is often helpful to look at
similar features which are already implemented.  For example, if you
want to add a new directive to the reStructuredText parser, look at
the implementation of a similar directive in
<code class="docutils literal notranslate"><span class="pre">docutils/parsers/rst/directives/</span></code>.</p>
<div class="section" id="modifying-the-document-tree-before-it-is-written">
<h3><a class="toc-backref" href="#id9">Modifying the Document Tree Before It Is Written</a><a class="headerlink" href="#modifying-the-document-tree-before-it-is-written" title="永久链接至标题">¶</a></h3>
<p>You can modify the document tree right before the writer is called.
One possibility is to use the <a class="reference external" href="../api/publisher.html#publish_doctree">publish_doctree</a> and
<a class="reference external" href="../api/publisher.html#publish_from_doctree">publish_from_doctree</a> functions.</p>
<p>To retrieve the document tree, call:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">document</span> <span class="o">=</span> <span class="n">docutils</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">publish_doctree</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>Please see the docstring of publish_doctree for a list of parameters.</p>
<p><code class="docutils literal notranslate"><span class="pre">document</span></code> is the root node of the document tree.  You can now
change the document by accessing the <code class="docutils literal notranslate"><span class="pre">document</span></code> node and its
children—see <a class="reference internal" href="#the-node-interface">The Node Interface</a> below.</p>
<p>When you’re done with modifying the document tree, you can write it
out by calling:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">output</span> <span class="o">=</span> <span class="n">docutils</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">publish_from_doctree</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="the-node-interface">
<h3><a class="toc-backref" href="#id10">The Node Interface</a><a class="headerlink" href="#the-node-interface" title="永久链接至标题">¶</a></h3>
<p>As described in the overview above, Docutils’ internal representation
of a document is a tree of nodes.  We’ll now have a look at the
interface of these nodes.</p>
<p>(To be completed.)</p>
</div>
</div>
<div class="section" id="what-now">
<h2><a class="toc-backref" href="#id11">What Now?</a><a class="headerlink" href="#what-now" title="永久链接至标题">¶</a></h2>
<p>This document is not complete.  Many topics could (and should) be
covered here.  To find out with which topics we should write about
first, we are awaiting <em>your</em> feedback.  So please ask your questions
on the <a class="reference external" href="../user/mailing-lists.html#docutils-develop">Docutils-develop</a> mailing list.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Nosy

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>